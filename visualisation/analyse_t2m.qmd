---
title: "Contour"
author: "Hajmi Hanaa"
date: "2025-12-01"
format: 
  html:
    toc: true
    toc-depth: 3
    theme: cosmo
    code-fold: true
execute:
  echo: true
  warning: false
  message: false
jupyter: julia-1.11
---

```{julia}
using CairoMakie
using Shapefile
using GeoInterface

# --------------------------------------------------------------------
# 1. Fonction pour charger tous les points d'un shapefile
# --------------------------------------------------------------------
function collect_points_from_shapefile(shp_path::String)
    xs_all = Float64[]
    ys_all = Float64[]
    tbl = Shapefile.Table(shp_path)

    for feat in tbl
        geom = Shapefile.shape(feat)
        coords = GeoInterface.coordinates(geom)

        if coords isa Vector{Vector{Vector{Vector{Float64}}}}   # MultiPolygon
            for poly in coords
                for ring in poly
                    append!(xs_all, first.(ring))
                    append!(ys_all, last.(ring))
                end
            end

        elseif coords isa Vector{Vector{Vector{Float64}}}       # Polygon
            for ring in coords
                append!(xs_all, first.(ring))
                append!(ys_all, last.(ring))
            end
        end
    end

    return xs_all, ys_all
end

# --------------------------------------------------------------------
# 2. Chemins vers les shapefiles (Lambert-93)
# --------------------------------------------------------------------
regions_shp      = "../data/shapefiles/region.shp"
departements_shp = "../data/shapefiles/departement.shp"

# On collecte les points pour connaître le cadre de la France
xs_reg, ys_reg = collect_points_from_shapefile(regions_shp)
xs_dep, ys_dep = collect_points_from_shapefile(departements_shp)

xmin = min(minimum(xs_reg), minimum(xs_dep))
xmax = max(maximum(xs_reg), maximum(xs_dep))
ymin = min(minimum(ys_reg), minimum(ys_dep))
ymax = max(maximum(ys_reg), maximum(ys_dep))

# On ajoute une petite marge
dx = 0.05 * (xmax - xmin)
dy = 0.05 * (ymax - ymin)
xmin -= dx; xmax += dx
ymin -= dy; ymax += dy

# --------------------------------------------------------------------
# 3. Figure Makie (juste la carte)
# --------------------------------------------------------------------
fig = Figure(resolution = (800, 600))
ax = Axis(fig[1, 1],
    xlabel = "Lambert-93 X (m)",
    ylabel = "Lambert-93 Y (m)",
    title  = "Carte de la France\nRégions et départements",
    aspect = DataAspect()
)

xlims!(ax, xmin, xmax)
ylims!(ax, ymin, ymax)

# --------------------------------------------------------------------
# 4. Tracer les régions
# --------------------------------------------------------------------
tbl_reg = Shapefile.Table(regions_shp)
for feat in tbl_reg
    geom = Shapefile.shape(feat)
    coords = GeoInterface.coordinates(geom)

    if coords isa Vector{Vector{Vector{Vector{Float64}}}}   # MultiPolygon
        for poly in coords
            for ring in poly
                xs = first.(ring)
                ys = last.(ring)
                lines!(ax, xs, ys, color = :black, linewidth = 2)
            end
        end
    elseif coords isa Vector{Vector{Vector{Float64}}}       # Polygon
        for ring in coords
            xs = first.(ring)
            ys = last.(ring)
            lines!(ax, xs, ys, color = :black, linewidth = 2)
        end
    end
end

# --------------------------------------------------------------------
# 5. Tracer les départements (plus fins)
# --------------------------------------------------------------------
tbl_dep = Shapefile.Table(departements_shp)
for feat in tbl_dep
    geom = Shapefile.shape(feat)
    coords = GeoInterface.coordinates(geom)

    if coords isa Vector{Vector{Vector{Vector{Float64}}}}   # MultiPolygon
        for poly in coords
            for ring in poly
                xs = first.(ring)
                ys = last.(ring)
                lines!(ax, xs, ys, color = :gray30, linewidth = 1)
            end
        end
    elseif coords isa Vector{Vector{Vector{Float64}}}       # Polygon
        for ring in coords
            xs = first.(ring)
            ys = last.(ring)
            lines!(ax, xs, ys, color = :gray30, linewidth = 1)
        end
    end
end

fig
save("carte_france_regions_departements.png", fig)
```

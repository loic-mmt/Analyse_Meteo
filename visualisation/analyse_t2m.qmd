---
title: "Contour"
author: "Hajmi Hanaa"
date: "2025-12-01"
format: 
  html:
    toc: true
    toc-depth: 3
    theme: cosmo
    code-fold: true
execute:
  echo: true
  warning: false
  message: false
jupyter: julia-1.11
---
```{julia}
# 1) Packages
############################
using NCDatasets
using Statistics
using Plots
using Shapefile
using GeoInterface  # pour lire les géométries (MultiPolygon, etc.)

############################
# 2) Lecture ERA5 NetCDF
############################
nc_path = "test_era5_t2m_20250101_0000.nc"  
ds = NCDataset(nc_path)

t2m = ds["t2m"][:]          
lat = ds["latitude"][:]
lon = ds["longitude"][:]

close(ds)

############################
# 3) Reshape en grille 2D
############################
nx, ny = length(lon), length(lat)
t2m_grid = reshape(t2m, nx, ny)

############################
# 4) Masque France (simple bbox)
lat_min, lat_max = 41.0, 51.5
lon_min, lon_max = -5.0, 9.5

france_mask = falses(nx, ny)
for i in 1:nx, j in 1:ny
    france_mask[i, j] = (lat[j] ≥ lat_min && lat[j] ≤ lat_max &&
                         lon[i] ≥ lon_min && lon[i] ≤ lon_max)
end

t2m_fr = copy(t2m_grid)
t2m_fr[.!france_mask] .= NaN

############################
# 5) Poids spatiaux + moyenne pondérée
############################
# Poids = cos(latitude)
lat_rad = deg2rad.(lat)
weights_lat = cos.(lat_rad)
weights_grid = repeat(weights_lat', nx, 1)

vals = t2m_grid[france_mask]
wts  = weights_grid[france_mask]
t2m_weighted_mean = sum(vals .* wts) / sum(wts)

println("Weighted mean temperature over France ≈ ",
        round(t2m_weighted_mean, digits=2), " (units as in NetCDF)")

############################
# 6) Fonction pour dessiner les contours d’un shapefile (régions)
############################
function overlay_shapefile_boundaries!(shp_path::AbstractString; linecolor=:black, lw=0.8)
    tbl = Shapefile.Table(shp_path)

    for feat in tbl
        geom = feat.geometry

        # GeoInterface.coordinates renvoie une structure imbriquée :
        # Polygon -> [ring1, ring2, ...], ring -> [(x,y), (x,y), ...]
        # MultiPolygon -> [poly1, poly2, ...]
        coords = GeoInterface.coordinates(geom)

        # Détecter si MultiPolygon (3 niveaux) ou Polygon (2 niveaux)
        # MultiPolygon: coords[poly][ring][pt]
        # Polygon:      coords[ring][pt]
        if !isempty(coords) && !isempty(coords[1]) && isa(coords[1][1], Tuple)
            # Polygon
            for ring in coords
                xs = first.(ring)
                ys = last.(ring)
                plot!(xs, ys; seriestype=:path, color=linecolor, linewidth=lw, label=false)
            end
        else
            # MultiPolygon
            for poly in coords
                for ring in poly
                    xs = first.(ring)
                    ys = last.(ring)
                    plot!(xs, ys; seriestype=:path, color=linecolor, linewidth=lw, label=false)
                end
            end
        end
    end
    return nothing
end

############################
# 7) Visualisation + contours régions
############################
p = heatmap(
    lon, lat, t2m_fr',
    xlabel="Longitude", ylabel="Latitude",
    title="ERA5 t2m over France (masked) + regional borders",
    color=:thermal
)

#xlims!(p, -6, 10)   
ylims!(p, 4e6, 8e6)
# Shapefile des régions (ex: ADMIN_EXPRESS, régions, etc.)
regions_shp      = "../data/shapefiles/region.shp"
departements_shp = "../data/shapefiles/departement.shp"
overlay_shapefile_boundaries!(regions_shp; linecolor=:black, lw=1.0)
overlay_shapefile_boundaries!(departements_shp; linecolor=:black, lw=0.4)
savefig(p, "carte_t2m_france.png")
p
```
